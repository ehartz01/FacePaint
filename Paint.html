<!DOCTYPE html>

<html>
<head>

<title>Comp 86 example</title>
<!-- Based on: Marijn Haverbeke, Eloquent JavaScript, http://eloquentjavascript.net/index.html -->

<script type="text/javascript">
/*
 * Global list of tools, indexed by (user-visible) tool name
 */
tools = {};

/*
 * Individual controls/widgets
 */

class ToolControl { 
    constructor (cx) { 
	var select = elt("select");
	for (var toolname in tools)
	    select.appendChild (elt ("option", null, toolname));

	cx.canvas.addEventListener ("mousedown", function(event) { 
        if (event.which == 1) { 
		tools[select.value].down (event, cx); 
		event.preventDefault(); 
	    }
	});

    	this.elt = elt ("span", null, "Tool: ", select); 
    }
}

class ColorControl {
    constructor (cx) {
	// Some browsers will provide a color picker, others default to text field
	var input = elt("input", {type: "color"});

	input.addEventListener("change", function() {
	    cx.fillStyle = input.value;
	    cx.strokeStyle = input.value;
	});

	this.elt = elt ("span", null, "Color: ", input); 
    }
}

class BrushControl {
    constructor (cx) {
	var select = elt("select");
	var sizes = [1, 2, 3, 5, 8, 12, 25, 35, 50, 75, 100];
	sizes.forEach (function(size) {
	    select.appendChild (elt("option", {value: size},
                           size + " pixels"));
	});

	select.addEventListener("change", function() {
	    cx.lineWidth = select.value;
	});

	this.elt = elt("span", null, "Brush size: ", select); 
    }
}

/*
 * Drawing modes (tools)
 */

/* Base class contains common routines, used by several subclasses */
class Tool {
    trackDrag(onMove, onEnd) { 
	addEventListener("mousemove", onMove); 
	addEventListener("mouseup", end); 

	function end(event) { 
	    removeEventListener("mousemove", onMove); 
	    removeEventListener("mouseup", end); 
	    if (onEnd) onEnd(event); 
	}
    }

    /*
     * Utility function: Convert from window-relative to element-relative position
     * event.clientX and element.getBoundingClientRect() are both relative to top-left of screen
     */
    static relativePos(event, element) {
	var rect = element.getBoundingClientRect();
	return {x: Math.floor(event.clientX - rect.left),
	    y: Math.floor(event.clientY - rect.top)};
    }
}

class LineTool extends Tool { 
    down (event, cx, onEnd) { 
	cx.lineCap = "round";

	var pos = Tool.relativePos (event, cx.canvas);
	this.trackDrag(function(event) { 
	    cx.beginPath(); 
	    cx.moveTo(pos.x, pos.y); 
	    pos = Tool.relativePos(event, cx.canvas); 
	    cx.lineTo(pos.x, pos.y); 
	    cx.stroke(); 
	}, onEnd); 
    }
}

class EraseTool extends Tool {
    down (event, cx) { 
	cx.globalCompositeOperation = "destination-out"; 
	tools.Line.down (event, cx, function() { 
	    cx.globalCompositeOperation = "source-over"; 
	});
    }
}

class TextTool extends Tool {
    down (event, cx) {
	var text = prompt("Text:", "");
	if (text) {
	    var pos = Tool.relativePos(event, cx.canvas);
	    cx.font = Math.max(7, cx.lineWidth) + "px sans-serif";
	    cx.fillText(text, pos.x, pos.y);
	}
    }
}

class SprayTool extends Tool {
    down (event, cx) {
	var radius = cx.lineWidth / 2;
	var area = radius * radius * Math.PI;
	var dotsPerTick = Math.ceil(area / 30);

	var currentPos = Tool.relativePos(event, cx.canvas);
	var spray = setInterval(function() {
	    for (var i = 0; i < dotsPerTick; i++) {
		var offset = SprayTool.randomPointInRadius(radius);
		cx.fillRect(currentPos.x + offset.x,
			    currentPos.y + offset.y, 1, 1);
	    }
	}, 25);

	this.trackDrag (function(event) {
	    currentPos = Tool.relativePos(event, cx.canvas);
	}, function() {
	    clearInterval(spray);
	});
    }

    static randomPointInRadius (radius) {
	while (true) { 
	    var x = Math.random() * 2 - 1; 
	    var y = Math.random() * 2 - 1; 
	    if (x * x + y * y <= 1) 
	        return {x: x * radius, y: y * radius}; 
	}
    }
}

/*
 * Main object
 */
class Main {
    constructor (parent) {
	var canvas = elt("canvas", {width: 500, height: 300}); 
	var cx = canvas.getContext("2d");
	
	tools.Line = new LineTool ();
	tools.Erase = new EraseTool ();
	tools.Text = new TextTool ();
	tools.Spray = new SprayTool ();

	var toolbar = elt("div", {class: "toolbar"}); 
	toolbar.appendChild (new ToolControl (cx).elt); 
	toolbar.appendChild (new ColorControl (cx).elt); 
	toolbar.appendChild (new BrushControl (cx).elt); 

	var panel = elt("div", {class: "picturepanel"}, canvas); 
	parent.appendChild(elt("div", null, panel, toolbar)); 
    }
}

/*
 * Utility function: creates a new DOM element with specified name and
 * attributes and appends all further arguments it gets as child nodes,
 * automatically converting strings to text nodes.
 */
function elt(name, attributes) { 
  var node = document.createElement(name); 
  if (attributes) {
    for (var attr in attributes)
      if (attributes.hasOwnProperty(attr))
        node.setAttribute(attr, attributes[attr]);
  }
  for (var i = 2; i < arguments.length; i++) {
    var child = arguments[i];
    if (typeof child == "string")
      child = document.createTextNode(child);
    node.appendChild(child);
  }
  return node; 
}

window.onload = function () { 
    new Main (document.body); 
}
</script>

<style>
.picturepanel {
    width: 500px;
    height: 300px;
    border: 3px solid #336699;
    overflow: auto;
    position: relative;
}

.picturepanel canvas {
    display: block;
}

.toolbar > * {
    margin-right: 5px;
}

.toolbar {
    font-family: arial, sans-serif;
    color: #336699;
}
</style>

</head>
</html>
